<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dipy &mdash; dipy 0.12.0dev documentation</title>
    
    <link rel="stylesheet" href="../_static/dipy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.12.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="dipy 0.12.0dev documentation" href="../index.html" />
  <meta name="keywords" content="dipy, dMRI, DTI, DSI, diffusion MRI, Tensor,
  neuroimaging, python, neuroscience, Eleftherios, Garyfallidis, tractography,
  streamlines, fiber tracking">

  </head>
  <body role="document">
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="../index.html">
  <img src="../_static/dipy-banner.png" alt="dipy logo"  border="0" />
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
  <li><a href="../index.html">Home</a> |&nbsp;</li>
  <li><a href="../stateoftheart.html">Overview</a> |&nbsp;</li>
  <li><a href="../examples_index.html">Gallery</a> |&nbsp;</li>
  <li><a href="../installation.html">Download</a> |&nbsp;</li>
  <li><a href="../subscribe.html">Subscribe</a> |&nbsp;</li>
  <li><a href="../developers.html">Developers</a> |&nbsp;</li>
  <li><a href="../cite.html">Cite</a> &nbsp;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">


<h4> Site Navigation </h4>
  <ul>
    <li><a href="../documentation.html">Documentation</a></li>
    <li><a href="../devel/index.html">Development</a></li>
  </ul>

<h4> NIPY Community </h4>
  <ul class="simple">
    <li><a class="reference external"
	href="http://nipy.org/">Community Home</a></li>
    <li><a class="reference external"
	href="http://nipy.org/software/projects/">NIPY Projects</a></li>
    <li><a class="reference external"
	href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing List</a></li>
    <li><a class="reference external"
	href="http://nipy.org/nipy/license.html">License</a></li>
  </ul>


  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples_built/combined_workflow_creation.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>

<div id="searchbox-ml" style="display: none">
  <h3>Search mailing list archive</h3>
  <script type="text/javascript">
    function mlsearch(curobj)
    {
    curobj.q.value="site:mail.python.org/pipermail/neuroimaging/ "+curobj.userquery.value
    }
  </script>
  <form action="http://www.google.com/search" method="get" onSubmit="mlsearch(this)">
    <input name="userquery" size="13" type="text" /> <input type="submit" value="Go" />
    <input name="q" type="hidden" />
  </form>
</div>

<div id="searchbox-site" style="display: none">
  <h3>Search this site</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="13" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script type="text/javascript">$('#searchbox-ml').show(0);</script>
<script type="text/javascript">$('#searchbox-site').show(0);</script>


<script>
     ((window.gitter = {}).chat = {}).options = {
       room: 'nipy/dipy'
     };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="creating-a-new-combined-workflow">
<span id="example-combined-workflow-creation"></span><h1>Creating a new combined workflow.<a class="headerlink" href="#creating-a-new-combined-workflow" title="Permalink to this headline">Â¶</a></h1>
<p>A combined workflow is a series of dipy workflows organized together in a way
that the output of a workflow serves as input for the next one.</p>
<p>First create your combined workflow class. Your combine workflow class file
is usually located in the ../dipy/workflows directory.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.workflows.combined_workflow</span> <span class="kn">import</span> <span class="n">CombinedWorkflow</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">CombinedWorkflow</span></code> is the base class that will be extended to create our
combined workflow.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.workflows.denoise</span> <span class="kn">import</span>  <span class="n">NLMeansFlow</span>
<span class="kn">from</span> <span class="nn">dipy.workflows.segment</span> <span class="kn">import</span> <span class="n">MedianOtsuFlow</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">MedianOtsuFlow</span></code> and <code class="docutils literal"><span class="pre">NLMeansFlow</span></code> will be combined to create our
processing section.</p>
<div class="highlight-python"><div class="highlight"><pre>class DenoiseAndSegment(CombinedWorkflow):
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">DenoiseAndSegment</span></code> is the name of our combined workflow. Note that
it needs to extend CombinedWorkflow for everything to work properly.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_sub_flows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">NLMeansFlow</span><span class="p">,</span>
        <span class="n">MedianOtsuFlow</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>It is mandatory to implement this method if you want to make all the sub
workflows parameters available in commandline.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_files</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;processed.nii.gz&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_files : string</span>
<span class="sd">        Path to the input files. This path may contain wildcards to</span>
<span class="sd">        process multiple inputs at once.</span>

<span class="sd">    out_dir : string, optional</span>
<span class="sd">        Where the resulting file will be saved. (default &#39;&#39;)</span>

<span class="sd">    out_file : string, optional</span>
<span class="sd">        Name of the result file to be saved. (default &#39;processed.nii.gz&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Just like a normal workflow, it is mandatory to have out_dir as a
parameter. It is also mandatory to put &#8216;<a href="#id1"><span class="problematic" id="id2">out_</span></a>&#8216; in front of every
parameter that is going to be an output. Lastly, all <a href="#id3"><span class="problematic" id="id4">out_</span></a> params needs
to be at the end of the params list.
The class docstring part is very important, you need to document
every parameter as they will be used with inspection to build the
command line argument parser.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">io_it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_io_iterator</span><span class="p">()</span>

<span class="k">for</span> <span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span> <span class="ow">in</span> <span class="n">io_it</span><span class="p">:</span>
    <span class="n">nl_flow</span> <span class="o">=</span> <span class="n">NLMeansFlow</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_sub_flow</span><span class="p">(</span><span class="n">nl_flow</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="n">denoised</span> <span class="o">=</span> <span class="n">nl_flow</span><span class="o">.</span><span class="n">last_generated_outputs</span><span class="p">[</span><span class="s1">&#39;out_denoised&#39;</span><span class="p">]</span>

    <span class="n">me_flow</span> <span class="o">=</span> <span class="n">MedianOtsuFlow</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_sub_flow</span><span class="p">(</span><span class="n">me_flow</span><span class="p">,</span> <span class="n">denoised</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">)</span>
</pre></div>
</div>
<p>Use self.get_io_iterator() in every workflow you create. This creates
an <code class="docutils literal"><span class="pre">IOIterator</span></code> object that create output file names and directory structure
based on the inputs and some other advanced output strategy parameters.</p>
<p>Iterating on the <code class="docutils literal"><span class="pre">IOIterator</span></code> object you created previously you
conveniently get all input and output paths for every input file
found when globbin the input parameters.</p>
<p>In the IOIterator loop you can see how we create a new NLMeans workflow then
run it using self.run_sub_flow. Running it this way will pass any workflow
specific parameter that was retreived from the command line and will append the
ones you specify as optional parameters (out_dir in this case).</p>
<p>Lastly, the outputs paths are retrived using workflow.last_generated_outputs.
This allows to use <code class="docutils literal"><span class="pre">denoise</span></code> as the input for the <code class="docutils literal"><span class="pre">MedianOtsuFlow</span></code></p>
<p>This is it for the combined workflow class! Now to be able to call it easily via
command line, you need this last bit of code. It is usually in an executable
file located in ../dipy/bin/.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.workflows.flow_runner</span> <span class="kn">import</span> <span class="n">run_flow</span>
</pre></div>
</div>
<p>This is the method that will wrap everything that is needed to make a workflow
ready then run it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run_flow</span><span class="p">(</span><span class="n">DenoiseAndSegment</span><span class="p">())</span>
</pre></div>
</div>
<p>This is the only thing needed to make your workflow available through command
line.</p>
<p>Now just call the script you just made with -h to see the argparser help text.</p>
<p><cite>python combined_workflow_creation.py &#8211;help</cite></p>
<p>You should see all your parameters available along with some extra common ones
like logging file and force overwrite. Also all the documentation you wrote
about each parameter is there. Also note that every sub workflow optional
parameter is available.</p>
<p>Now call it for real with a nifti file to see the results. Experiment
with the parameters and see the results.</p>
<p><cite>python combined_workflow_creation.py volume.nii.gz</cite></p>
<div class="highlight-python"><div class="highlight"><pre>.. admonition:: Example source code
</pre></div>
</div>
<blockquote>
<div>You can download <a class="reference download internal" href="../_downloads/combined_workflow_creation.py" download=""><code class="xref download docutils literal"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></code></a>.
This same script is also included in the dipy source distribution under the
<code class="file docutils literal"><span class="pre">doc/examples/</span></code> directory.</div></blockquote>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
  <li><a href="../index.html">Home</a> |&nbsp;</li>
  <li><a href="../stateoftheart.html">Overview</a> |&nbsp;</li>
  <li><a href="../examples_index.html">Gallery</a> |&nbsp;</li>
  <li><a href="../installation.html">Download</a> |&nbsp;</li>
  <li><a href="../subscribe.html">Subscribe</a> |&nbsp;</li>
  <li><a href="../developers.html">Developers</a> |&nbsp;</li>
  <li><a href="../cite.html">Cite</a> &nbsp;</li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2008-2016, dipy developers &lt;neuroimaging@python.org&gt;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>